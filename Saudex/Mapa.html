<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mapa de Sa√∫de</title>
  <link rel="stylesheet" href="css/mapa.css">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

</head>
<body>
  <header>Encontre um Posto de Atendimento üè•</header>

  <main>
    <div id="controls">
      <label for="cep">Digite o CEP:</label>
      <input type="text" id="cep" placeholder="Ex: 09750-730" />
      <button onclick="buscarEndereco()">Buscar</button>

      <div class="filtros">
        <label><input type="checkbox" id="filtroHospital" checked onchange="filtrarMarcadores()"> Hospital</label>
        <label><input type="checkbox" id="filtroFarmacia" checked onchange="filtrarMarcadores()"> Farm√°cia</label>
        <label><input type="checkbox" id="filtroClinica" checked onchange="filtrarMarcadores()"> Cl√≠nica</label>
      </div>

      <button onclick="resetMapa()">Resetar Mapa</button>

      <div id="locaisLista"></div>
    </div>

    <div id="mapa">
      <div id="spinner"></div>
    </div>
  </main>

  <footer>Desenvolvido com Leaflet.js e OpenStreetMap | Sa√∫dex</footer>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <script>
    "use strict";

    let mapa, marcadorUsuario, ultimaPosicao;
    let marcadores;
    const posicaoInicial = [-23.6913, -46.5658]; // S√£o Bernardo do Campo

    const icones = {
      hospital: L.icon({ iconUrl: "https://cdn-icons-png.flaticon.com/512/2967/2967350.png", iconSize: [36,36], popupAnchor:[0,-10]}),
      farmacia: L.icon({ iconUrl: "https://cdn-icons-png.flaticon.com/512/2967/2967356.png", iconSize: [36,36], popupAnchor:[0,-10]}),
      clinica: L.icon({ iconUrl: "https://cdn-icons-png.flaticon.com/512/2967/2967362.png", iconSize: [36,36], popupAnchor:[0,-10]})
    };

    function mostrarSpinner(show) {
      document.getElementById("spinner").style.display = show ? "block" : "none";
    }

    function inicializarMapa(lat, lon) {
      if (!mapa) {
        mapa = L.map("mapa").setView([lat, lon], 14);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19, attribution:'¬© OpenStreetMap contributors'}).addTo(mapa);

        marcadores = L.markerClusterGroup({
          spiderfyOnMaxZoom: true,
          showCoverageOnHover: false,
          zoomToBoundsOnClick: true,
          disableClusteringAtZoom: 18
        });
        mapa.addLayer(marcadores);

        const legenda = L.control({ position: "bottomleft" });
        legenda.onAdd = function () {
          const div = L.DomUtil.create("div", "info-legend");
          div.innerHTML = `
            <b>Legenda:</b><br>
            <div><img src="${icones.hospital.options.iconUrl}"> Hospital</div>
            <div><img src="${icones.farmacia.options.iconUrl}"> Farm√°cia</div>
            <div><img src="${icones.clinica.options.iconUrl}"> Cl√≠nica</div>
          `;
          return div;
        };
        legenda.addTo(mapa);

        const resetBtn = L.control({ position: "topleft" });
        resetBtn.onAdd = function () {
          const div = L.DomUtil.create("div", "leaflet-control-custom");
          div.innerHTML = "‚Ü© Reset";
          div.style.backgroundColor="white";
          div.style.border="2px solid #007bff";
          div.style.padding="5px 8px";
          div.style.borderRadius="6px";
          div.style.cursor="pointer";
          div.style.color="#007bff";
          div.onclick = resetMapa;
          return div;
        };
        resetBtn.addTo(mapa);
      } else {
        mapa.setView([lat, lon], 14);
      }
    }

    async function buscarEndereco() {
      const cep = document.getElementById("cep").value.replace(/\D/g,"");
      if(cep.length!==8){ alert("Digite um CEP v√°lido!"); return; }

      mostrarSpinner(true);
      const resp = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
      const dados = await resp.json();
      if(dados.erro){ mostrarSpinner(false); alert("CEP n√£o encontrado!"); return; }

      const endereco = `${dados.logradouro}, ${dados.bairro}, ${dados.localidade}`;
      const urlGeo = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(endereco)}`;
      const respGeo = await fetch(urlGeo);
      const geo = await respGeo.json();
      if(geo.length===0){ mostrarSpinner(false); alert("N√£o foi poss√≠vel localizar o endere√ßo."); return; }

      const lat = parseFloat(geo[0].lat);
      const lon = parseFloat(geo[0].lon);
      ultimaPosicao = [lat, lon];
      inicializarMapa(lat, lon);

      if(marcadorUsuario) marcadorUsuario.remove();
      marcadorUsuario = L.marker([lat, lon]).addTo(mapa).bindPopup("Seu endere√ßo aproximado").openPopup();

      await carregarLocais(lat, lon);
      mostrarSpinner(false);
    }

    async function carregarLocais(lat, lon){
      marcadores.clearLayers();
      document.getElementById("locaisLista").innerHTML = "";

      const query = `
        [out:json];
        (
          node["amenity"="hospital"](around:2000,${lat},${lon});
          node["amenity"="pharmacy"](around:2000,${lat},${lon});
          node["healthcare"~"clinic|doctors"](around:2000,${lat},${lon});
        ); out body;
      `;
      const url = "https://overpass-api.de/api/interpreter?data="+encodeURIComponent(query);
      const resp = await fetch(url);
      const dados = await resp.json();

      dados.elements.forEach(el=>{
        if(!el.lat || !el.lon || !el.tags) return;
        let tipo = el.tags.amenity || (el.tags.healthcare?"clinica":null);
        let icone = icones[tipo]; 
        if(!icone) return;

        const marcador = L.marker([el.lat, el.lon], { icon: icone });
        marcador.tipo = tipo;
        marcadores.addLayer(marcador);

        const listaDiv = document.createElement("div");
        listaDiv.textContent = el.tags.name||tipo;
        listaDiv.onclick = ()=>{ mapa.setView([el.lat,el.lon],17); marcador.openPopup(); };
        document.getElementById("locaisLista").appendChild(listaDiv);
      });

      filtrarMarcadores();
    }

    function filtrarMarcadores(){
      const showHospital = document.getElementById("filtroHospital").checked;
      const showFarmacia = document.getElementById("filtroFarmacia").checked;
      const showClinica = document.getElementById("filtroClinica").checked;

      marcadores.eachLayer(m=>{
        const tipo = m.tipo;
        if((tipo==="hospital" && showHospital) || (tipo==="farmacia" && showFarmacia) || (tipo==="clinica" && showClinica)){
          marcadores.addLayer(m);
        } else {
          marcadores.removeLayer(m);
        }
      });
    }

    function resetMapa(){
      mapa.setView(posicaoInicial,14);
      filtrarMarcadores();
    }

    window.addEventListener("load", async ()=>{
      ultimaPosicao = posicaoInicial;
      inicializarMapa(posicaoInicial[0], posicaoInicial[1]);

      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          marcadorUsuario = L.marker([lat,lon]).addTo(mapa).bindPopup("Voc√™ est√° aqui").openPopup();
          mapa.setView([lat,lon],14);
          carregarLocais(lat,lon);
        }, ()=>{
          carregarLocais(posicaoInicial[0],posicaoInicial[1]);
        });
      } else {
        carregarLocais(posicaoInicial[0],posicaoInicial[1]);
      }
    });
  </script>
</body>
</html>
