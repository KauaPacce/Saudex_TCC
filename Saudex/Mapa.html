<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mapa de Sa√∫de</title>
  <link rel="stylesheet" href="css/mapa.css">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

</head>
<body>
  <header>Encontre um Posto de Atendimento üè•</header>

  <main>
    <div id="controls">
      <label for="cep">Digite o CEP:</label>
      <input type="text" id="cep" name="cep" placeholder="00000000" required maxlength="8" />
      <button onclick="buscarEndereco()">Buscar</button>

      <div class="filtros">
        <label><input type="checkbox" id="filtroHospital" checked onchange="filtrarMarcadores()"> Hospital</label>
        <label><input type="checkbox" id="filtroFarmacia" checked onchange="filtrarMarcadores()"> Farm√°cia</label>
        <label><input type="checkbox" id="filtroClinica" checked onchange="filtrarMarcadores()"> Cl√≠nica</label>
      </div>

      <button onclick="resetMapa()">Resetar Mapa</button>

      <div id="locaisLista"></div>
    </div>

    <div id="mapa">
      <div id="spinner"></div>
    </div>
  </main>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <script>
    "use strict";

    let mapa, marcadorUsuario, ultimaPosicao;
    let marcadores;
    const posicaoInicial = [-23.6913, -46.5658]; // S√£o Bernardo do Campo

    const icones = {
      hospital: L.icon({ iconUrl: "https://cdn-icons-png.flaticon.com/512/2967/2967350.png", iconSize: [36,36], popupAnchor:[0,-10]}),
      farmacia: L.icon({ iconUrl: "https://cdn-icons-png.flaticon.com/512/2967/2967356.png", iconSize: [36,36], popupAnchor:[0,-10]}),
      clinica: L.icon({ iconUrl: "https://cdn-icons-png.flaticon.com/512/2967/2967362.png", iconSize: [36,36], popupAnchor:[0,-10]})
    };

    function mostrarSpinner(show) {
      document.getElementById("spinner").style.display = show ? "block" : "none";
    }

    function inicializarMapa(lat, lon) {
      if (!mapa) {
        mapa = L.map("mapa").setView([lat, lon], 14);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19, attribution:'¬© OpenStreetMap contributors'}).addTo(mapa);

        marcadores = L.markerClusterGroup({
          spiderfyOnMaxZoom: true,
          showCoverageOnHover: false,
          zoomToBoundsOnClick: true,
          disableClusteringAtZoom: 18
        });
        mapa.addLayer(marcadores);

        const legenda = L.control({ position: "bottomleft" });
        legenda.onAdd = function () {
          const div = L.DomUtil.create("div", "info-legend");
          div.innerHTML = `
            <b>Legenda:</b><br>
            <div><img src="${icones.hospital.options.iconUrl}"> Hospital</div>
            <div><img src="${icones.farmacia.options.iconUrl}"> Farm√°cia</div>
            <div><img src="${icones.clinica.options.iconUrl}"> Cl√≠nica</div>
          `;
          return div;
        };
        legenda.addTo(mapa);

        const resetBtn = L.control({ position: "topleft" });
        resetBtn.onAdd = function () {
          const div = L.DomUtil.create("div", "leaflet-control-custom");
          div.innerHTML = "‚Ü© Reset";
          div.style.backgroundColor="white";
          div.style.border="2px solid #007bff";
          div.style.padding="5px 8px";
          div.style.borderRadius="6px";
          div.style.cursor="pointer";
          div.style.color="#007bff";
          div.onclick = resetMapa;
          return div;
        };
        resetBtn.addTo(mapa);
      } else {
        mapa.setView([lat, lon], 14);
      }
    }

    async function buscarEndereco() {
      const cep = document.getElementById("cep").value.replace(/\D/g,"");
      if(cep.length !== 8){
        alert("Digite um CEP v√°lido (8 d√≠gitos)!");
        return;
      }

      mostrarSpinner(true);
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);

        const resp = await fetch(`https://viacep.com.br/ws/${cep}/json/`, { signal: controller.signal });
        clearTimeout(timeoutId);
        if (!resp.ok) throw new Error('Erro na API ViaCEP (rede ou servidor)');
        const dados = await resp.json();
        if(dados.erro) throw new Error('CEP n√£o encontrado. Verifique o n√∫mero.');

        const endereco = `${dados.logradouro}, ${dados.bairro}, ${dados.localidade}`;
        const urlGeo = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(endereco)}&country=Brasil`; // Adicionado pa√≠s para precis√£o
        const respGeo = await fetch(urlGeo, { signal: controller.signal });
        if (!respGeo.ok) throw new Error('Erro na API Nominatim (rede ou servidor)');
        const geo = await respGeo.json();
        if(geo.length === 0) throw new Error('Endere√ßo n√£o localizado. Tente um CEP mais espec√≠fico.');

        const lat = parseFloat(geo[0].lat);
        const lon = parseFloat(geo[0].lon);
        ultimaPosicao = [lat, lon];
        inicializarMapa(lat, lon);

        if(marcadorUsuario) marcadorUsuario.remove();
        marcadorUsuario = L.marker([lat, lon]).addTo(mapa).bindPopup("Seu endere√ßo aproximado").openPopup();

        await carregarLocais(lat, lon);
      } catch (erro) {
        console.error('Erro em buscarEndereco:', erro);
        alert(erro.message || 'Erro ao buscar endere√ßo. Verifique sua conex√£o e tente novamente.');
      } finally {
        mostrarSpinner(false);
      }
    }

    async function carregarLocais(lat, lon){
      const cacheKey = `locais_${lat.toFixed(2)}_${lon.toFixed(2)}`;
      const cached = localStorage.getItem(cacheKey);
      if (cached) {
        const data = JSON.parse(cached);
        if (Date.now() - data.timestamp < 60 * 60 * 1000) { // Cache de 1h
          renderizarLocais(data.locais);
          return;
        }
      }

      try {
        marcadores.clearLayers();
        document.getElementById("locaisLista").innerHTML = "";

        const query = `
          [out:json];
          (
            node["amenity"="hospital"]["name"](around:5000,${lat},${lon});
            node["amenity"="pharmacy"]["name"](around:5000,${lat},${lon});
            node["healthcare"="clinic"]["name"](around:5000,${lat},${lon});
            node["healthcare"="doctors"]["name"](around:5000,${lat},${lon});
          ); out;
        `;
        const url = "https://overpass-api.de/api/interpreter?data="+encodeURIComponent(query);
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000);
        const resp = await fetch(url, { signal: controller.signal });
        clearTimeout(timeoutId);
        if (!resp.ok) throw new Error('Erro na API Overpass');
        const dados = await resp.json();

        const locais = [];
        dados.elements.forEach(el=>{
          if(!el.lat || !el.lon || !el.tags || !el.tags.name) return;
          let tipo = el.tags.amenity || (el.tags.healthcare ? "clinica" : null);
          let icone = icones[tipo]; 
          if(!icone) return;
          locais.push({ lat: el.lat, lon: el.lon, tipo, nome: el.tags.name });
        });

        // Fallback se poucos locais
        if (locais.length < 5) {
          locais.push(...dadosEstaticos(lat, lon));
        }

        localStorage.setItem(cacheKey, JSON.stringify({ locais, timestamp: Date.now() }));
        renderizarLocais(locais);
      } catch(erro){
        console.error("Erro ao carregar locais:", erro);
        const locais = dadosEstaticos(lat, lon);
        renderizarLocais(locais);
        alert("Usando dados aproximados devido a erro na API.");
      }
    }

    function renderizarLocais(locais) {
      marcadores.clearLayers();
      document.getElementById("locaisLista").innerHTML = `<p>${locais.length} locais encontrados.</p>`;

      locais.forEach(l => {
        const marcador = L.marker([l.lat, l.lon], { icon: icones[l.tipo] });
        marcador.tipo = l.tipo;
        marcadores.addLayer(marcador);

        const listaDiv = document.createElement("div");
        listaDiv.textContent = l.nome;
        listaDiv.onclick = ()=>{ mapa.setView([l.lat, l.lon],17); marcador.openPopup(); };
        document.getElementById("locaisLista").appendChild(listaDiv);
      });
      filtrarMarcadores();
    }

    function dadosEstaticos(lat, lon) {
      return [
        { lat: lat + 0.01, lon: lon + 0.01, tipo: "hospital", nome: "Hospital Municipal (aprox.)" },
        { lat: lat - 0.01, lon: lon - 0.01, tipo: "farmacia", nome: "Farm√°cia Popular (aprox.)" },
        { lat: lat + 0.005, lon: lon - 0.005, tipo: "clinica", nome: "Cl√≠nica Geral (aprox.)" }
      ];
    }

    function filtrarMarcadores(){
      const showHospital = document.getElementById("filtroHospital").checked;
      const showFarmacia = document.getElementById("filtroFarmacia").checked;
      const showClinica = document.getElementById("filtroClinica").checked;

      marcadores.eachLayer(m=>{
        const tipo = m.tipo;
        const deveMostrar = (tipo==="hospital" && showHospital) || (tipo==="farmacia" && showFarmacia) || (tipo==="clinica" && showClinica);
        if(deveMostrar){
          if(!marcadores.hasLayer(m)) marcadores.addLayer(m);
        } else {
          marcadores.removeLayer(m);
        }
      });
    }

    function resetMapa(){
      mapa.setView(posicaoInicial,14);
      carregarLocais(posicaoInicial[0], posicaoInicial[1]);
    }

    async function obterLocalizacaoPorIP() {
      const cacheKey = 'localizacaoIP';
      const cached = localStorage.getItem(cacheKey);
      if (cached) {
        const data = JSON.parse(cached);
        if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
          return data.loc;
        }
      }

      try {
        const resp = await fetch('https://ipapi.co/json/');
        if (!resp.ok) throw new Error('Erro na API de IP');
        const dados = await resp.json();
        if (!dados.latitude || !dados.longitude) throw new Error('Dados inv√°lidos');
        const loc = { lat: parseFloat(dados.latitude), lon: parseFloat(dados.longitude) };
        localStorage.setItem(cacheKey, JSON.stringify({ loc, timestamp: Date.now() }));
        return loc;
      } catch (erro) {
        console.error('Erro ao obter localiza√ß√£o por IP:', erro);
        return null;
      }
    }

    window.addEventListener("load", async ()=>{
      ultimaPosicao = posicaoInicial;
      inicializarMapa(posicaoInicial[0], posicaoInicial[1]);

      let lat, lon;

      if (navigator.geolocation) {
        try {
          const pos = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 });
          });
          lat = pos.coords.latitude;
          lon = pos.coords.longitude;
        } catch (erro) {
          console.warn('Geolocaliza√ß√£o falhou:', erro);
        }
      }

      if (!lat || !lon) {
        const ipLoc = await obterLocalizacaoPorIP();
        if (ipLoc) {
          lat = ipLoc.lat;
          lon = ipLoc.lon;
        }
      }

      if (!lat || !lon) {
        lat = posicaoInicial[0];
        lon = posicaoInicial[1];
      }

      ultimaPosicao = [lat, lon];
      inicializarMapa(lat, lon);
      marcadorUsuario = L.marker([lat, lon]).addTo(mapa).bindPopup("Voc√™ est√° aqui (aproximado)").openPopup();
      await carregarLocais(lat, lon);
    });

  </script>
</body>
</html>